â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                  â•‘
â•‘     ğŸ”§ FIX RESTAURATION SQL - COMMANDES NON-STANDARD            â•‘
â•‘                                                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PROBLÃˆME IDENTIFIÃ‰
------------------
Votre backup SQL contient des commandes NON-STANDARD :
- \restrict GVpaPS3QsQoG5QS9tNpdMNSed2ufre3QKQ6qfbQBXiUXAOkg3Elz3dHuFvnfd2a
- \unrestrict GVpaPS3QsQoG5QS9tNpdMNSed2ufre3QKQ6qfbQBXiUXAOkg3Elz3dHuFvnfd2a

Ces commandes ne sont PAS reconnues par PostgreSQL standard.
Elles viennent probablement d'un outil de chiffrement externe.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SOLUTION 1 : CODE CORRIGÃ‰ (AUTOMATIQUE)
---------------------------------------

Le code backend a Ã©tÃ© modifiÃ© pour nettoyer automatiquement ces
commandes lors de la restauration.

Ã‰TAPES :
1. Sur le VPS, pull le code corrigÃ© :
   cd ~/apps/Metro && git pull origin main

2. Rebuild backend :
   docker-compose build --no-cache backend
   docker-compose restart backend

3. Essayer de restaurer depuis le frontend :
   Mon compte â†’ Sauvegardes â†’ Restaurer un backup

âœ… Le systÃ¨me va automatiquement supprimer les lignes problÃ©matiques

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SOLUTION 2 : NETTOYAGE MANUEL (SI SOLUTION 1 Ã‰CHOUE)
----------------------------------------------------

A. Avec le script bash :

bash clean-sql-backup.sh "/Users/mabs/Downloads/Metro Backup Dec 10 2025.sql"

Cela va crÃ©er : "Metro Backup Dec 10 2025_cleaned.sql"

B. Ou avec Node.js :

node fix-backup-restore.js "/Users/mabs/Downloads/Metro Backup Dec 10 2025.sql"

Cela va crÃ©er : "Metro Backup Dec 10 2025_cleaned.sql"

C. Puis restaurer le fichier nettoyÃ© :

# Copier le fichier nettoyÃ© sur le VPS
scp "Metro Backup Dec 10 2025_cleaned.sql" root@vps:~/

# Sur le VPS
docker exec -i metro-postgres psql -U metro -d metro_db < ~/Metro\ Backup\ Dec\ 10\ 2025_cleaned.sql

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SOLUTION 3 : COMMANDE ONE-LINER (RAPIDE)
-----------------------------------------

Sur votre Mac (oÃ¹ est le fichier SQL) :

grep -v '^\\(un\)\?restrict' "/Users/mabs/Downloads/Metro Backup Dec 10 2025.sql" > "/Users/mabs/Downloads/Metro_Backup_CLEAN.sql"

Puis upload et restore sur VPS.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

VÃ‰RIFICATION APRÃˆS FIX
----------------------

1. Nombre de lignes :
   - Original : 1245 lignes
   - NettoyÃ© : 1243 lignes (2 lignes supprimÃ©es)

2. Les 2 lignes supprimÃ©es sont :
   - Ligne 5 : \restrict ...
   - Ligne 1244 : \unrestrict ...

3. Test restauration :
   docker-compose logs backend --tail=50 | grep -i "restaur"
   
   âœ… Devrait afficher : "Backup restaurÃ© avec succÃ¨s"
   âŒ Si erreur, partager les logs

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

POURQUOI CES COMMANDES ?
-------------------------

Ces commandes \restrict/\unrestrict viennent probablement de :
- Un outil de backup Hostinger personnalisÃ©
- Une extension PostgreSQL tierce
- Un systÃ¨me de chiffrement/sÃ©curitÃ© ajoutÃ©

PostgreSQL standard ne les reconnaÃ®t pas â†’ Erreur restauration

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PROCHAINE FOIS
--------------

Pour Ã©viter ce problÃ¨me Ã  l'avenir :

1. CrÃ©er backups depuis le frontend Metro :
   Mon compte â†’ Sauvegardes â†’ CrÃ©er backup
   
   âœ… Ces backups seront propres (pg_dump standard)

2. Ou utiliser pg_dump direct :
   docker exec metro-postgres pg_dump -U metro metro_db > backup.sql
   
   âœ… Pas de commandes non-standard

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

COMMIT CORRIGÃ‰
--------------

Commit: 40b3fe5
Date: 10 dÃ©cembre 2025
Fichiers modifiÃ©s:
- backend/src/utils/backup.ts (nettoyage auto)
- clean-sql-backup.sh (nettoyage manuel)
- fix-backup-restore.js (nettoyage manuel Node)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TESTEZ MAINTENANT
-----------------

cd ~/apps/Metro && git pull origin main && docker-compose build --no-cache backend && docker-compose restart backend

Puis essayer de restaurer depuis le frontend !

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

